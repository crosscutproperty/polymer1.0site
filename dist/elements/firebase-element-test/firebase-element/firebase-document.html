<link rel="import" href="../polymer/polymer.html"><link rel="import" href="firebase.html"><link rel="import" href="firebase-query-behavior.html"><script>
  Polymer({
    is: 'firebase-document',

    behaviors: [
      Polymer.FirebaseQueryBehavior
    ],

    properties: {

      /**
       * Firebase Query object corresponding to `location`.
       */
      query: {
        type: Object,
        notify: true,
        computed: '_computeQuery(location)',
        observer: '_queryChanged'
      },

      /**
       * The `data` object mapped to `location`.
       */
      data: {
        type: Object,
        notify: true
      }
    },

    listeners: {
      'firebase-value': '_onFirebaseValue'
    },

    _localDataChanged: function(change) {
      var pathFragments = change.path.split('.');

      if (pathFragments.length === 1) {
        this._updateRemoteDocument();
        return;
      }

      this._setRemoteDocumentChild(
        pathFragments[1],
        change.base[pathFragments[1]]
      );
    },

    _onFirebaseValue: function(event) {
      this._applyRemoteDataChange(function() {
        this.set('data', event.detail.val());
      });
    },

    _computeQuery: function(location) {
      if (!location) {
        return;
      }
      var query;
      try {
      
        query =  new Firebase(location);
      
      } catch(e) {
        
        this._fireQueryError('Query cannot be instantiated with location ' + location + ' (' + e.toString() + ')');

      } finally {
        return query;
      }
    },

    _updateRemoteDocument: function() {
      this._log('Updating remote document');
      
      if (!this.query) {

        this._fireQueryError('Query does not exist');
        return; 

      }

      this.query.update(this.dataAsObject);
      
    },

    _setRemoteDocumentChild: function(key, value) {
      if (!this.query) {

        this._fireQueryError('Query does not exist');
        return; 

      }

      this.debounce('set-' + key, function() {
        this._log('Setting child "' + key + '" to', value);
        this.query.child(key).set(value);
      });
    
    },

    _removeRemoteDocumentChild: function(key) {
      this._log('Removing child "' + key + '"');
      
      if (!this.query) {

        this._fireQueryError('Query does not exist');
        return; 

      }

      this.query.child(key).remove();
    }
  });
</script>